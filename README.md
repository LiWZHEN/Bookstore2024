# <center> BookStore-2024 总体设计文档 </center>
<div style="text-align: center;">李文桢</div>

## 程序功能概述
本程序意在实现一个书店系统，可供游客、顾客、销售人员以及店长使用。根据身份权限的不同，用户可以使用注册、登录、创建用户、查询图书、图书信息录入、图书信息修改、进货、购买图书、查询销售情况、查看工作情况报告、查询采购信息、查询盈利信息、查看系统整体工作日志中的全部或部分功能。
## 主体逻辑说明
* 用存储登录状态的文件记录当前登录用户
* 用TokenScanner实现指令预处理
* 根据不同的command把任务交给各个函数
  * 先检查用户权限
  * 各函数分别实现对数据库（文件）中信息的读写

## 代码文件结构
#### i.e. main函数与各个类的关系
main 函数包括以下几个类：
* ### TokenScanner类
main函数中用，读取一行信息后直接切片。
* ### 哈希类
每一项涉及用户身份与图书ISBN号的操作都要用。
* ### 权限类
包含哈希类，在“用户信息”文件头索引中二分查找。
* ### 用户类
包含哈希类、权限类。
* ### 书籍信息类
包含TokenScanner类、哈希类、权限类。
* ### 工作日志类
包含哈希类、权限类。
## 功能设计
| 模块名称         | 存储                                           | 输入         | 输出                                              |
|--------------|----------------------------------------------|------------|-------------------------------------------------|
| 注册           | user.txt                                     | 用户名、密码     | 用户名合法且唯一 -> 反馈操作成功信息 // 用户名重复 -> 反馈错误信息         |
| 登录           | 存入登录栈                                        | 用户名、密码     | 用户名存在于“身份信息”中,且密码匹配 -> 输出登录成功信息 // 否则 -> 登录失败信息 |
| 创建用户         | 分配个人ID，并把操作数据存入user.txt、worker.txt、diary.txt | 个人信息、员工用户名 | 反馈操作信息                                          |
| 查询图书         | -                                            | 关键字        | 图书信息                                            |
| 图书信息录入       | 把数据存入book.txt、worker.txt、diary.txt           | 图书信息、员工用户名 | 反馈操作信息                                          |
| 图书信息修改       | 修改book.txt，并把数据存入worker.txt、diary.txt        | 图书信息、员工用户名 | 反馈操作信息                                          |
| 进货           | 修改import.txt、book.txt、worker.txt、diary.txt   | 图书信息、员工用户名 | 反馈操作信息                                          |
| 购买图书         | 把数据更改存入book.txt、sale.txt、diary.txt           | ISBN号、购买数量 | 反馈操作信息                                          |
| 查看全体员工工作情况报告 | -                                            | 员工用户名      | 操作种类、操作对象                                       |
| 财务记录查询       | -                                            | -          | 财务记录                                            |
| 查询财务信息       | -                                            | 截止时间       | 【报表】单次利润                                        |
| 查看系统整体工作日志   | -                                            | （无）        | 【报表】操作时间、操作者、操作种类、操作对象                          |
| 退出系统         | 清空登录栈                                        | -          | -                                               |
## 数据库设计
> * user.txt
>   * 开头是一个索引，存放每个块内最小的用户名哈希值
>   * 后面跟着一系列固定大小的块，每一个都是“块内数据量n + n * 用户信息结构体”
> * book.txt
>   * 开头是一个索引，存放每个块内最小的ISBN哈希值
>   * 后面是一系列块，每一个都是“块内数据量n + n * 图书信息结构体”
> * sale.txt
>   * 开头是一个索引，存放每个块内最小的操作次序号
>   * 后面是一系列块，每一个都是“块内数据量n + n * 截至某时刻的账目结构体”
> * diary.txt
>   * 开头是一个索引，存放每个块内最小的操作次序号
>   * 后面是一系列块，每一个都是“块内数据量n + n * 某时刻的操作结构体”
> * worker.txt
>   * 开头是一个索引，存放每个块内最小的员工用户名哈希值
>   * 后面是一系列块，每一个都是“块内数据量n + n * 某时刻的操作结构体”  
>     > * 区别于diary，这里结构体优先按照员工用户名哈希值排序，再按操作时间排序
> * import.txt
>   * 开头是一个索引，存放每个块内最小的采购时间
>   * 后面是一系列块，每一个都是“块内数据量n + n * 某时刻的进货信息结构体”

## 类、结构体设计

* ### 类
  * TokenScanner类
    > 指令预处理
  * 哈希类
    > 字符串双哈希，便于用户信息的排序与查找
    > * 字符串 -> 双哈希值
    > * 重载运算符，便于比较
  * 权限类
    > 获取当前用户权限，判断其是否能执行当前指令
  * 用户类
    > * 注册  {0}
    > * 登录 {0}
    > * 注销（登出）用户 {1}
    > * 修改密码 {1}
    > * 创建用户 {3}
    > * 删除用户 {7}
  * 书籍信息类
    > * 检索书籍 {1}
    > * 购买书籍 {1}
    > * 选择书籍 {3}
    > * 录入书籍信息 {3}
    > * 修改书籍信息 {3}
    > * 进货时对书籍信息的修改 {3}
    > * 销售时对书籍信息的修改 {1}
  * 工作日志类
    > * 更新员工个人工作情况 {3}
    > * 更新系统整体操作信息 {1}
    > * 更新财务信息
    >   * 进货时的支出 {3}
    >   * 销售时的收入 {1}
    > * 更新进货信息 {3}
    > * 查询财务信息 {7}
    > * 生成财务记录 {7}
    > * 生成员工工作情况报告 {7}
    > * 生成日志 {7}

* ### 结构体
  * 用户信息
    > {用户名哈希值，用户名，用户密码哈希值，用户权限}
  * 图书信息
    > {图书ISBN哈希值，图书ISBN，图书名，作者名，{用于搜索的关键词}，库存量，单价}
  * 用于搜索的关键词
    > {哈希值数组}
  * 总账目
    > {总收入，总支出}
  * 截至某时刻的账目
    > {该时刻对应的操作次序号，总收入，总支出，收支变化}
  * 某时刻的操作
    > {该时刻对应的操作次序号，操作者用户名，操作种类，{操作对象}}
  * 操作对象
    > 使用union，存与操作种类匹配的数据
  * 进货信息
    > {采购时间，ISBN号，数量，进货价格}