# <center> BookStore-2024 总体设计文档 </center>
<div style="text-align: center;">李文桢</div>

## 程序功能概述
本程序意在实现一个书店系统，可供游客、顾客、销售人员以及店长使用。根据身份权限的不同，用户可以使用注册、登录、创建用户、查询图书、图书信息录入、图书信息修改、进货、购买图书、查询销售情况、查看工作情况报告、查询采购信息、查询盈利信息、查看系统整体工作日志中的全部或部分功能。
## 主体逻辑说明
* 用存储登录状态的文件记录当前登录用户
* 用TokenScanner实现指令预处理
* 根据不同的command把任务交给各个函数
  * 先检查用户权限
  * 各函数分别实现对登录栈或者数据库（文件）中信息的读写

## 代码文件结构
#### i.e. main函数与各个类的关系
main 函数包括以下几个类：
* ### TokenScanner类
main函数中用，读取一行信息后切片。
* ### 书籍信息（book_data）、用户信息（user_data）
包含文件读写，其中使用了定长数组结构体、文件头索引结构体和块结构体。
* ### 书名->ISBN（book_name_processor）
维护各书名对应的ISBN，使用双哈希对书名排序，以vector向主程序传递符合条件的书的ISBN。
* ### 作者->ISBN（author_processor）
维护各作者名对应的ISBN，使用双哈希对作者名排序，以vector向主程序传递符合条件的书的ISBN。
* ### keyword->ISBN（key_file）
维护各keyword（单个）对应的ISBN，使用双哈希对keyword排序，以vector向主程序传递符合条件的书的ISBN。
* ### keywords->keyword（key_processor）
把多个keywords拆分，利用key_file进行处理。
* ### 财务（finance）
在内存（vector）中存历史财务信息。
* ### 工作日志
包含哈希类、权限类。
* ### 登录栈控制（log_in_and_out）
封装对登录栈（含用户ID、选择书籍、用户权限）的控制
## 功能设计
| 模块名称         | 存储                                        | 输入             | 输出                     |
|--------------|-------------------------------------------|----------------|------------------------|
| 注册           | users.txt                                 | 用户名、密码、ID      | 用户名重复 -> 反馈错误信息        |
| 登录           | logging_stack、users.txt                   | 用户名、密码         | （登录失败信息）               |
| 登出           | users.txt                                 | -              | 登录栈为空 -> 反馈错误信息        |
| 创建用户         | users.txt、diary.txt                       | 用户信息           | 反馈操作信息                 |
| 修改密码         | users.txt、diary.txt                       | ID、密码          | 反馈操作信息                 |
| 删除用户         | users.txt、diary.txt                       | ID             | 反馈操作信息                 |
| 查询图书         | -                                         | ISBN/关键字/书名/作者 | 图书信息                   |
| 图书信息录入       | book.txt、worker.txt、diary.txt             | 图书信息、员工用户名     | 反馈操作信息                 |
| 图书信息修改       | book.txt、worker.txt、diary.txt             | 图书信息、员工用户名     | 反馈操作信息                 |
| 进货           | book.txt、worker.txt、diary.txt、finance.txt | 图书信息、员工用户名     | 反馈操作信息                 |
| 购买图书         | books.txt、finance.txt、diary.txt           | ISBN号、购买数量     | 反馈操作信息                 |
| 查看全体员工工作情况报告 | -                                         | -              | 操作者ID、操作种类、操作对象        |
| 财务记录查询       | -                                         | -              | 财务记录                   |
| 查询财务信息       | -                                         | 截止时间           | 【报表】单次利润               |
| 查看系统整体工作日志   | -                                         | （无）            | 【报表】操作时间、操作者、操作种类、操作对象 |
| 退出系统         | 清空登录栈，重置用户登录状态                            | -              | -                      |
## 数据库设计
> * users.txt
>   * 开头是一个索引，存放每个块内最小的ID
>   * 后面跟着一系列固定大小的块，每一个都是“块内数据量n + n * 用户信息结构体”
> * books.txt
>   * 开头是一个索引，存放每个块内最小的ISBN
>   * 后面是一系列块，每一个都是“块内数据量n + n * 图书信息结构体”
> * book_name.txt
>  * 开头是一个索引，存放每个块内最小的book_name哈希值
>  * 后面是一系列块，每一个都是“块内数据量n + n * book_name->ISBN结构体”
> * author.txt
>  * 开头是一个索引，存放每个块内最小的author哈希值
>  * 后面是一系列块，每一个都是“块内数据量n + n * author->ISBN结构体”
> * keyword.txt
>  * 开头是一个索引，存放每个块内最小的keyword哈希值
>  * 后面是一系列块，每一个都是“块内数据量n + n * keyword->ISBN结构体”
> * finance.txt
>   * 开头是当前记录数
>   * 后面是一系列块，按时间自然排列
> * diary.txt
>   * 开头是当前记录数
>   * 后面是一系列块，按时间自然排列
> * worker.txt
>   * 开头是一个索引，存放每个块内最小的员工用户名哈希值
>   * 后面是一系列块，每一个都是“块内数据量n + n * 某时刻的操作结构体”  
>     > * 区别于diary，这里结构体优先按照员工用户名哈希值排序，再按操作时间排序

## 类、结构体设计

* ### 类
  * TokenScanner
  * 哈希式文件存储
  * 定长数组式文件存储
  * 用户
  * 书籍信息
  * 关键词处理
  * 工作日志

* ### 结构体
  * 用户信息
    > {用户ID，用户名，用户密码哈希值，用户权限，登录次数}
  * 图书信息
    > {图书ISBN，图书名，作者名，{用于搜索的关键词}，库存量，单价}
  * 截至某时刻的账目
    > {该时刻对应的操作次序号，总收入，总支出，收支变化}
  * 某时刻的操作
    > {该时刻对应的操作次序号，操作者用户名，操作种类，{操作对象}}
  * 操作对象
    > 使用union，存与操作种类匹配的数据
  * 进货信息
    > {采购时间，ISBN号，数量，进货价格}